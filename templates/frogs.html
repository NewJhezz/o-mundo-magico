{% extends "base.html" %}

{% block title %}Sapos de Chocolate | Cole√ß√£o de Bruxos{% endblock %}

{% block content %}
<div class="frogs-page animate-fade-in">
    <!-- Header com Voltar -->
    <div class="header-decoration"
        style="display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 2rem;">
        <a href="{{ url_for('world') }}" class="tab-link back-btn" title="Voltar para O Mundo M√°gico"
            style="position: absolute; left: 0; margin: 0; padding: 0.5rem 1rem;">
            ‚¨Ö
        </a>
        <h2 style="text-align: center; color: var(--gold-primary); font-family: var(--font-heading); margin: 0;">
            Sapos de Chocolate
        </h2>
    </div>

    <!-- Navega√ß√£o de Sub-abas -->
    <div class="frogs-tabs" style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 3rem;">
        <button class="tab-link active" onclick="switchFrogTab('gacha')" id="tab-gacha">üßô‚Äç‚ôÇÔ∏è Abrir Pacote</button>
        <button class="tab-link" onclick="switchFrogTab('album')" id="tab-album">üìö Meu √Ålbum</button>
    </div>

    <!-- √ÅREA 1: O MINIGAME (GACHA) -->
    <div id="section-gacha" class="frog-section">
        <div class="game-container">
            <div id="frogPackage" class="frog-package-wrapper">
                <!-- Pacote Estilo Pro (Baseado na imagem) -->
                <div class="package-pro" onclick="openPackage()">
                    <div class="package-face">
                        <div class="ornament-top"></div>
                        <div class="ornament-bottom"></div>
                        <div class="package-content">
                            <span class="brand-text">Chocolate</span>
                            <span class="frog-icon">üê∏</span>
                            <span class="brand-text">Frog</span>
                        </div>
                    </div>
                </div>
                <div class="package-shadow"></div>
            </div>

            <div id="rewardArea" class="reward-area hidden">
                <!-- A figurinha aparecer√° aqui -->
            </div>
        </div>
    </div>

    <div id="section-album" class="frog-section hidden">
        <div class="album-container">
            <!-- Capa/Lombada Simulada -->
            <div class="album-book">
                <div class="album-page left-page">
                    <h3 class="album-page-title">Grandes Bruxos</h3>
                    <div id="albumGridLeft" class="album-grid">
                        <!-- Figurinhas do lado esquerdo -->
                    </div>
                </div>
                <div class="album-divider"></div>
                <div class="album-page right-page">
                    <h3 class="album-page-title">Mestres das Artes</h3>
                    <div id="albumGridRight" class="album-grid">
                        <!-- Figurinhas do lado direito -->
                    </div>
                </div>
            </div>

            <div class="album-controls" style="text-align: center; margin-top: 2rem;">
                <p class="album-stats">Cole√ß√£o: <span id="collectedCount">0</span>/{{ wizards|length }}</p>
                <button class="tab-link reset-btn" onclick="resetCollection()"
                    style="font-size: 0.7rem; opacity: 0.4; margin-top: 1rem;">Zerar Progresso Bruxo</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalhe da Figurinha (Zoom do √Ålbum) -->
    <div id="albumDetailModal" class="modal-overlay hidden" onclick="closeAlbumDetail()">
        <div class="modal-content card-zoom-modal" onclick="event.stopPropagation()">
            <div id="zoomContent"></div>
            <button class="modal-close" onclick="closeAlbumDetail()">&times;</button>
        </div>
    </div>
</div>

<!-- Overlay de Explos√£o M√°gica -->
<div id="magicExplosion" class="magic-explosion-overlay hidden">
    <div class="explosion-flash"></div>
    <div class="explosion-particles"></div>
</div>

<style>
    /* Tabs Internas */
    .frog-section {
        min-height: 500px;
    }

    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        perspective: 1500px;
        padding: 2rem;
    }

    /* PACOTE PRO (Azul Real e Dourado) */
    .frog-package-wrapper {
        position: relative;
        cursor: pointer;
        width: 280px;
        height: 280px;
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
    }

    .frog-package-wrapper:hover {
        transform: scale(1.05) rotateY(10deg);
    }

    .package-pro {
        width: 100%;
        height: 100%;
        background: #1a237e;
        /* Blue de fundo */
        border: 4px solid var(--gold-primary);
        clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), inset 0 0 30px rgba(0, 0, 0, 0.5);
        background-image:
            radial-gradient(circle at center, #283593 0%, #1a237e 70%);
        animation: float-3d 4s ease-in-out infinite;
    }

    /* Ornamentos Dourados G√≥ticos Detalhados */
    .package-face::before,
    .package-face::after {
        content: '‚öúÔ∏è';
        position: absolute;
        color: var(--gold-primary);
        font-size: 1.5rem;
        opacity: 0.6;
    }

    .package-face::before {
        top: 40px;
        left: 20px;
        transform: rotate(-45deg);
    }

    .package-face::after {
        top: 40px;
        right: 20px;
        transform: rotate(45deg);
    }

    /* Ornamentos Dourados G√≥ticos */
    .ornament-top {
        position: absolute;
        top: 10%;
        width: 80%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
        opacity: 0.5;
    }

    .ornament-bottom {
        position: absolute;
        width: 150px;
        height: 80px;
        background-image: url('https://www.transparenttextures.com/patterns/gold-scale.png');
        /* Mock de textura */
        opacity: 0.3;
        pointer-events: none;
    }

    .package-face::before {
        content: '';
        position: absolute;
        inset: 10px;
        border: 2px solid rgba(212, 175, 55, 0.3);
        clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
        pointer-events: none;
    }

    .package-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        z-index: 2;
    }

    .brand-text {
        font-family: var(--font-heading);
        color: var(--gold-primary);
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 1px 1px 2px #000;
    }

    .frog-icon {
        font-size: 5rem;
        filter: drop-shadow(0 0 15px rgba(255, 100, 0, 0.4));
        animation: frog-shake 2s infinite ease-in-out;
    }

    @keyframes frog-shake {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }
    }

    @keyframes float-3d {

        0%,
        100% {
            transform: translateY(0) rotateX(10deg) rotateY(-5deg);
        }

        50% {
            transform: translateY(-20px) rotateX(15deg) rotateY(10deg);
        }
    }

    /* Anima√ß√£o Espalhafatosa de Abertura */
    .shaking {
        animation: shake-crazy 0.5s infinite;
    }

    @keyframes shake-crazy {
        0% {
            transform: translate(1px, 1px) rotate(0deg);
        }

        10% {
            transform: translate(-1px, -2px) rotate(-1deg);
        }

        20% {
            transform: translate(-3px, 0px) rotate(1deg);
        }

        30% {
            transform: translate(3px, 2px) rotate(0deg);
        }

        40% {
            transform: translate(1px, -1px) rotate(1deg);
        }

        50% {
            transform: translate(-1px, 2px) rotate(-1deg);
        }

        60% {
            transform: translate(-3px, 1px) rotate(0deg);
        }

        70% {
            transform: translate(3px, 1px) rotate(-1deg);
        }

        80% {
            transform: translate(-1px, -1px) rotate(1deg);
        }

        90% {
            transform: translate(1px, 2px) rotate(0deg);
        }

        100% {
            transform: translate(1px, -2px) rotate(-1deg);
        }
    }

    /* Explos√£o */
    .magic-explosion-overlay {
        position: fixed;
        inset: 0;
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .explosion-flash {
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 0 200px 100px white, 0 0 400px 200px var(--gold-primary);
        animation: flash-out 0.8s ease-out forwards;
    }

    @keyframes flash-out {
        0% {
            transform: scale(0);
            opacity: 1;
        }

        100% {
            transform: scale(50);
            opacity: 0;
        }
    }

    /* A Figurinha */
    .wizard-card-pentagon {
        width: 300px;
        min-height: 380px;
        background: rgba(15, 25, 50, 0.98);
        backdrop-filter: blur(15px);
        border: 4px solid var(--gold-primary);
        clip-path: polygon(50% 0%, 100% 25%, 100% 100%, 0% 100%, 0% 25%);
        padding: 3rem 1.5rem 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        box-shadow: 0 0 60px rgba(0, 0, 0, 0.8), 0 0 30px rgba(212, 175, 55, 0.2);
        animation: card-entry 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes card-entry {
        from {
            transform: scale(0.5) translateY(200px) rotateY(180deg);
            opacity: 0;
        }

        to {
            transform: scale(1) translateY(0) rotateY(0);
            opacity: 1;
        }
    }

    .card-rarity {
        font-family: var(--font-heading);
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .card-rarity.legendary {
        background: var(--rarity-legendary);
        color: #000;
        box-shadow: 0 0 15px gold;
    }

    .card-rarity.rare {
        background: #c0c0c0;
        color: #000;
    }

    .card-rarity.common {
        background: #cd7f32;
        color: #fff;
    }

    .card-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .card-name {
        font-family: var(--font-heading);
        color: var(--gold-primary);
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
    }

    .card-title {
        font-style: italic;
        color: #fff;
        opacity: 0.7;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .card-desc {
        font-size: 0.85rem;
        line-height: 1.4;
        color: #e0e0e0;
        margin-top: 0.5rem;
        max-width: 100%;
        overflow-wrap: break-word;
    }

    /* Bot√£o Coletar */
    .collect-btn {
        margin-top: 2rem;
        background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
        color: #000;
        font-weight: bold;
        border: none;
        padding: 0.8rem 2rem;
        border-radius: 50px;
        cursor: pointer;
        font-family: var(--font-heading);
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        transition: all 0.3s;
    }

    .collect-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
    }

    /* √Ålbum Estilo Livro */
    .album-container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .album-book {
        background: #3e2723;
        /* Cor de couro velho */
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.9), inset 0 0 50px rgba(0, 0, 0, 0.5);
        display: flex;
        min-height: 700px;
        position: relative;
        border: 2px solid #5d4037;
    }

    .album-page {
        flex: 1;
        background: #fdf5e6;
        /* Papel envelhecido */
        background-image: url('https://www.transparenttextures.com/patterns/handmade-paper.png');
        padding: 2.5rem;
        box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .left-page {
        border-radius: 5px 0 0 5px;
        border-right: 1px solid rgba(0, 0, 0, 0.05);
    }

    .right-page {
        border-radius: 0 5px 5px 0;
        border-left: 1px solid rgba(0, 0, 0, 0.05);
    }

    .album-divider {
        width: 4px;
        background: linear-gradient(90deg, #2b1d1a, #5d4037, #2b1d1a);
        height: 100%;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
        z-index: 10;
    }

    .album-page-title {
        font-family: 'Cinzel', serif;
        color: #5d4037;
        text-align: center;
        margin-bottom: 2.5rem;
        font-size: 1.5rem;
        border-bottom: 1px double #8d6e63;
        padding-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .album-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 2.5rem 1.5rem;
        justify-items: center;
    }

    /* Slot de Figurinha no √Ålbum */
    .album-card-slot {
        width: 110px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.8rem;
        cursor: pointer;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .album-card-slot:hover {
        transform: scale(1.05) translateY(-5px);
    }

    /* Figurinha no √Ålbum (Miniatura do Pent√°gono) */
    .mini-wizard-card {
        width: 90px;
        height: 115px;
        background: rgba(15, 25, 50, 0.95);
        border: 2px solid var(--gold-primary);
        clip-path: polygon(50% 0%, 100% 25%, 100% 100%, 0% 100%, 0% 25%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.8rem 0.3rem;
        box-shadow: 2px 5px 10px rgba(0, 0, 0, 0.3);
        position: relative;
        filter: saturate(0.8) contrast(1.1);
    }

    .mini-wizard-card .mini-icon {
        font-size: 2.2rem;
        margin-bottom: 0.3rem;
    }

    .mini-wizard-card .mini-name-tag {
        font-family: var(--font-heading);
        font-size: 0.5rem;
        color: var(--gold-primary);
        text-align: center;
        text-transform: uppercase;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .mini-wizard-card .mini-rarity-dot {
        position: absolute;
        top: 25%;
        right: 8px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    /* Rarity Styles no Mini Card */
    .mini-wizard-card.legendary {
        border-color: gold;
        box-shadow: 0 0 10px gold;
    }

    .mini-wizard-card.legendary .mini-rarity-dot {
        background: gold;
        box-shadow: 0 0 5px gold;
    }

    .mini-wizard-card.rare .mini-rarity-dot {
        background: #c0c0c0;
    }

    .mini-wizard-card.common .mini-rarity-dot {
        background: #cd7f32;
    }

    /* Placeholder no √Ålbum (Contorno do Livro) */
    .card-placeholder {
        width: 90px;
        height: 115px;
        background: rgba(0, 0, 0, 0.03);
        border: 1px dashed rgba(93, 64, 55, 0.3);
        clip-path: polygon(50% 0%, 100% 25%, 100% 100%, 0% 100%, 0% 25%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: rgba(93, 64, 55, 0.2);
        font-family: var(--font-heading);
    }

    .album-name-label {
        font-family: 'Cinzel', serif;
        font-size: 0.65rem;
        color: #5d4037;
        font-weight: bold;
        text-align: center;
        opacity: 0.6;
    }

    .album-stats {
        font-family: var(--font-heading);
        color: var(--gold-primary);
        font-size: 0.9rem;
    }

    /* Zoom Modal */
    .card-zoom-modal {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    @keyframes pulse-gold {
        0% {
            transform: scale(1);
            filter: brightness(1);
        }

        50% {
            transform: scale(1.03);
            filter: brightness(1.2);
        }

        100% {
            transform: scale(1);
            filter: brightness(1);
        }
    }

    .newly-added {
        animation: pulse-gold 2s infinite;
    }

    /* Responsividade √Ålbum */
    @media (max-width: 950px) {
        .album-book {
            flex-direction: column;
            min-height: auto;
        }

        .album-divider {
            width: 100%;
            height: 4px;
            background: linear-gradient(180deg, #2b1d1a, #5d4037, #2b1d1a);
        }

        .left-page,
        .right-page {
            border-radius: 0;
            border: none;
        }

        .album-page {
            padding: 1.5rem;
        }
    }

    /* Responsividade Mobile para Cards */
    @media (max-width: 480px) {
        .wizard-card-pentagon {
            width: 280px;
            min-height: 350px;
            padding: 2.5rem 1rem 1.5rem 1rem;
        }

        .card-name {
            font-size: 1.2rem;
        }

        .card-icon {
            font-size: 3rem;
        }

        .game-container {
            padding: 1rem;
        }

        .frog-package-wrapper {
            width: 220px;
            height: 220px;
        }

        .frog-icon {
            font-size: 4rem;
        }
    }
</style>

<script>
    // Uso do filtro safe para garantir que o JSON n√£o seja escapado
    const allWizards = {{ wizards| tojson | safe }};
    let myCollection = [];

    try {
        myCollection = JSON.parse(localStorage.getItem('frogCollection')) || [];
    } catch (e) {
        console.error("Erro ao carregar cole√ß√£o:", e);
        myCollection = [];
    }

    // Inicializa abas e √°lbum
    document.addEventListener('DOMContentLoaded', () => {
        updateAlbumUI();
        switchFrogTab('gacha');
    });

    function switchFrogTab(tab) {
        const gachaSection = document.getElementById('section-gacha');
        const albumSection = document.getElementById('section-album');
        const tabGacha = document.getElementById('tab-gacha');
        const tabAlbum = document.getElementById('tab-album');

        if (gachaSection) gachaSection.classList.toggle('hidden', tab !== 'gacha');
        if (albumSection) albumSection.classList.toggle('hidden', tab !== 'album');
        if (tabGacha) tabGacha.classList.toggle('active', tab === 'gacha');
        if (tabAlbum) tabAlbum.classList.toggle('active', tab === 'album');
    }

    function openPackage() {
        const pkg = document.getElementById('frogPackage');
        if (!pkg) return;

        pkg.classList.add('shaking');

        setTimeout(() => {
            const explosion = document.getElementById('magicExplosion');
            if (explosion) explosion.classList.remove('hidden');

            // O PACOTE DESAPARECE ASSIM QUE A EXPLOS√ÉO COME√áA
            pkg.classList.add('hidden');
            pkg.classList.remove('shaking');

            setTimeout(() => {
                if (explosion) explosion.classList.add('hidden');
                revealReward();
            }, 600);
        }, 1000); // 1 segundo de suspense
    }

    function revealReward() {
        const rand = Math.random() * 100;
        let pool = [];
        if (rand < 10) pool = allWizards.filter(w => w.rarity === 'legendary');
        else if (rand < 40) pool = allWizards.filter(w => w.rarity === 'rare');
        else pool = allWizards.filter(w => w.rarity === 'common');

        if (pool.length === 0) pool = allWizards;
        const prize = pool[Math.floor(Math.random() * pool.length)];

        const rewardArea = document.getElementById('rewardArea');
        if (!rewardArea) return;

        rewardArea.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; gap: 2rem;">
                <div class="wizard-card-pentagon ${prize.rarity}">
                    <div class="card-rarity ${prize.rarity}">${prize.rarity_label}</div>
                    <div class="card-icon">${prize.icon}</div>
                    <h3 class="card-name">${prize.name}</h3>
                    <p class="card-title">${prize.title}</p>
                    <p class="card-desc">${prize.desc}</p>
                </div>
                <button class="collect-btn" onclick="collectCard('${prize.id}')" style="margin-top: 0;">
                    Adicionar ao √Ålbum
                </button>
            </div>
        `;
        rewardArea.classList.remove('hidden');
    }

    function collectCard(id) {
        console.log("Coletando figurinha:", id);

        if (!myCollection.includes(id)) {
            myCollection.push(id);
            try {
                localStorage.setItem('frogCollection', JSON.stringify(myCollection));
            } catch (e) {
                console.error("Erro ao salvar no localStorage:", e);
            }
        }

        // Esconde a figurinha e limpa a √°rea de recompensa
        const rewardArea = document.getElementById('rewardArea');
        if (rewardArea) {
            rewardArea.classList.add('hidden');
            rewardArea.innerHTML = '';
        }

        // Mostra o pacote novamente
        const pkgWrapper = document.getElementById('frogPackage');
        if (pkgWrapper) pkgWrapper.classList.remove('hidden');

        updateAlbumUI();

        // Feedback visual na aba √°lbum
        const albumTab = document.getElementById('tab-album');
        if (albumTab) {
            albumTab.style.borderColor = "var(--gold-primary)";
            albumTab.style.boxShadow = "0 0 20px var(--gold-primary)";
            setTimeout(() => {
                albumTab.style.borderColor = "";
                albumTab.style.boxShadow = "";
            }, 2000);
        }
    }

    function updateAlbumUI() {
        let count = 0;
        const leftGrid = document.getElementById('albumGridLeft');
        const rightGrid = document.getElementById('albumGridRight');
        if (!leftGrid || !rightGrid) return;

        leftGrid.innerHTML = '';
        rightGrid.innerHTML = '';

        allWizards.forEach((w, index) => {
            const isCollected = myCollection.includes(w.id);
            if (isCollected) count++;

            const slot = document.createElement('div');
            slot.className = 'album-card-slot';
            slot.onclick = () => isCollected ? zoomCard(w) : null;

            if (isCollected) {
                slot.innerHTML = `
                    <div class="mini-wizard-card ${w.rarity}">
                        <div class="mini-rarity-dot"></div>
                        <span class="mini-icon">${w.icon}</span>
                        <span class="mini-name-tag">${w.name}</span>
                    </div>
                    <span class="album-name-label" style="opacity: 1;">${w.name}</span>
                `;
            } else {
                slot.innerHTML = `
                    <div class="card-placeholder">?</div>
                    <span class="album-name-label">${w.name}</span>
                `;
            }

            // Divide as figurinhas entre as p√°ginas
            if (index < allWizards.length / 2) {
                leftGrid.appendChild(slot);
            } else {
                rightGrid.appendChild(slot);
            }
        });

        const counter = document.getElementById('collectedCount');
        if (counter) counter.innerText = count;
    }

    function zoomCard(prize) {
        const modal = document.getElementById('albumDetailModal');
        const content = document.getElementById('zoomContent');
        if (!modal || !content) return;

        content.innerHTML = `
            <div class="wizard-card-pentagon ${prize.rarity}">
                <div class="card-rarity ${prize.rarity}">${prize.rarity_label}</div>
                <div class="card-icon">${prize.icon}</div>
                <h3 class="card-name">${prize.name}</h3>
                <p class="card-title">${prize.title}</p>
                <p class="card-desc">${prize.desc}</p>
            </div>
        `;
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('open'), 10);
    }

    function closeAlbumDetail() {
        const modal = document.getElementById('albumDetailModal');
        if (!modal) return;
        modal.classList.remove('open');
        setTimeout(() => modal.classList.add('hidden'), 400);
    }

    function resetCollection() {
        if (confirm("Deseja realmente apagar sua cole√ß√£o de figurinhas?")) {
            myCollection = [];
            localStorage.removeItem('frogCollection');
            location.reload();
        }
    }
</script>
{% endblock %}